<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="tech notebook @ interfluidity">
    <meta name="keywords" content="Scala, tech, interfluidity">
    <meta name="author" content="Steve Randy Waldman">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="alternate" type="application/rss+xml" title="tech.interfluidity.com updates" href="../../../../feed/index.rss">
    <link rel="alternate" type="application/rss+xml" title="interfluidity - all blogs" href="https://www.interfluidity.com/unify-rss/all-blogs.rss">
    <link rel="alternate" type="application/rss+xml" title="interfluidity - all blogs and microblogs" href="https://www.interfluidity.com/unify-rss/all-blogs-and-microblogs.rss">
    <link rel="stylesheet" href="../../../../css/style.css">
    <link rel="stylesheet" href="../../../../css/highlightjs/steve-night-owl.css"><!-- theme for highlight.js -->
    <script src="../../../../js/highlight/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
          const regex = /(^.*)\-oldcommit\-[0-9A-Fa-f]+\.html/;
          const match = window.location.pathname.match(regex);
          if (match) {
              const b  = document.querySelector("body");
              const tb = document.getElementById("top-banner");
              b.classList.add("old-draft");
              tb.innerHTML = "You are looking at an old, superceded version of this page. For the current version, please <a href=\"" + match[1] + ".html\">click here</a>.";
          }
       });
    </script>
    <title>Readying a blog for revision histories and sprouts under unstatic</title>
  </head>
  <body>
    <div id="top-banner"></div>
    <div id="header">
      <div id="rss-link-container">
        <a id="rss-link" href="../../../../feed/index.rss"><span class="outer">(</span><span class="middle">(</span><span class="inner">(</span><span class="bullet">&bull;</span><span class="inner">)</span><span class="middle">)</span><span class="outer">)</span></a>
      </div>
      <div class="main-title"><a href="https://tech.interfluidity.com/">tech.interfluidity.com</a></div>
      <div class="tagline">a notebook by <a href="https://www.interfluidity.com/">steve&nbsp;randy&nbsp;waldman</a></div>
      <div class="see-also">&rarr; See also <a href="../../../../index.html">top</a>, <a href="../../../../archive.html">archive</a>, <a href="../../../../subscribe.html">subscribe</a>, <a href="https://drafts.interfluidity.com/">drafts blog</a>, <a href="https://www.interfluidity.com/">interfluidity main</a></div>
    </div>
    <div id="main">
      <div id="left-sidebar">
      </div>
      <div id="content">
        <div class="day-stamp">
 2024-06-02 <span class="arrow">⇒</span>
</div>
<article class="presentation-single uid-readying-a-blog-for-sprouts">
 <div class="entry-header">
  <h1><a href="index.html">Readying a blog for revision histories and sprouts under unstatic</a></h1>
  <hr class="below-title">
 </div>
 <div class="entry-body">
  <div class="flexmark markdown">
   <p>I've been developing support for my take on <a href="https://v5.chriskrycho.com/essays/feeds-are-not-fit-for-gardening/">Chris Krycho' "sprouts"</a> against this blog. Much of that support is now built into <a href="https://github.com/swaldman/unstatic"><code>unstatic</code></a>, my library for building static-site generators. But it does also require some support from within applicatons of that library, from the scala code and the <a href="https://github.com/swaldman/untemplate-doc">untemplates</a> of the individual site generators.</p>
   <p>I'm going to upgrade my <a href="https://drafts.interfluidity.com/archive.html">"drafts"</a> blog to support revisions, diffs, and sprouts. I'll document what it takes to do that here.</p>
   <h3><a href="#enable-revision--and-diff-generation-in-scala-code" id="enable-revision--and-diff-generation-in-scala-code" name="enable-revision--and-diff-generation-in-scala-code" class="anchorlink"></a>Enable revision- and diff-generation in Scala code</h3>
   <p>In the object <a href="https://github.com/swaldman/drafts.interfluidity.com/blob/main/src/com/interfluidity/drafts/DraftsSite.scala"><code>DraftsSite</code></a>, the <a href="https://github.com/swaldman/unstatic/blob/main/ztapir/src/unstatic/ztapir/ZTSite.scala"><code>unstatic.ztapir.ZTSite</code></a> that defines the site to be generated, inside the <a href="https://github.com/swaldman/unstatic/blob/main/ztapir/src/unstatic/ztapir/simple/SimpleBlog.scala"><code>unstatic.ztapir.simple.SimpleBlog</code></a> that defines the blog, add a <a href="https://github.com/swaldman/unstatic/blob/main/ztapir/src/unstatic/ztapir/simple/RevisionBinder.scala"><code>RevisionBinder</code></a> that can pull old revisions of pages and generate them into the website, and a <a href="https://github.com/swaldman/unstatic/blob/main/ztapir/src/unstatic/ztapir/simple/DiffBinder.scala"><code>DiffBinder</code></a> that can generate diffs between current and new revisions:</p>
   <pre><code class="language-scala"> override val revisionBinder : Option[RevisionBinder] = Some( RevisionBinder.GitByCommit(DraftsSite, JPath.of("."), siteRooted =&gt; Rel("public/").embedRoot(siteRooted)) )
 override val diffBinder     : Option[DiffBinder]     = Some( DiffBinder.JavaDiffUtils(DraftsSite) )
</code></pre>
   <p>By default, <code>SimpleBlog</code> sets these values to null. We override them.</p>
   <p>The <code>RevisionBinder</code> we are using is <code>RevisionBinder.GitByCommit</code>. Its constructor accepts</p>
   <ol>
    <li>our <code>ZTSite</code>;</li>
    <li>a file path (<code>java.nio.file.Path</code>) to the git repository in which revisions are stored, just '.' for us because the git repository is the static-site generator's working directory;</li>
    <li>a function that converts a site-rooted path (<a href="https://github.com/swaldman/unstatic/blob/main/src/unstatic/UrlPath.scala"><code>unstatic.UrlPath.Rooted</code></a>) into the associated path within the repository relative to its root (as <a href="https://github.com/swaldman/unstatic/blob/main/src/unstatic/UrlPath.scala"><code>unstatic.UrlPath.Rel</code></a>);</li>
    <li>A <code>RevisionBinder.RevisionPathFinder</code>, a function which takes a document's site-rooted path and a "revision spec" (which for this revision binder is a full-size hex git commit) and determines the path the revision should take within the site.</li>
   </ol>
   <p>We omit the fourth argument because we use a default, which coverts a path like <code>/a/b/whatever.html</code> to <code>/a/b/whatever-oldcommit-c6e71f4d689f2b208c3eae19e647435322fa6d04.html</code></p>
   <p>For a <code>DiffBinder</code>, we use <code>DiffBinder.JavaDiffUtils</code>, based on the <a href="https://github.com/java-diff-utils/java-diff-utils"><code>java-diff-utils</code></a> library. When we ask it to generate a diff for a path, we give it a reference to the <code>RevisionBinder.RevisionPathFinder</code> so it can know the filenames old versions get generated into. We also give it a <code>DiffBinder.DiffPathFinder</code>, which computes the pathnames of the generated diffs. Again, the <code>DiffBinder.DiffPathFinder</code> is omitted our code. We rely a default argument, which produces diff paths like <code>/a/b/whatever-diff-72eaf9fdfebc9e627bff33bbe1102d4d250ad1d0-to-199e44561de3fd9e731a335d8b2a655f42d9bc04.html</code>.</p>
   <p>Now, if we ever <a href="../green-shoots-of-sprouts/index.html">provide update histories</a> to any posts, copies of any old revisions referenced will be generated into the public directory of the site, as well as diffs between adjacent items in the update history.</p>
   <h3><a href="#modify-the-site-to-generate-update-histories-at-the-end-of-posts" id="modify-the-site-to-generate-update-histories-at-the-end-of-posts" name="modify-the-site-to-generate-update-histories-at-the-end-of-posts" class="anchorlink"></a>Modify the site to generate update histories at the end of posts</h3>
   <p>It's a matter of taste, but we'll display update histories only on single-post permalink pages, not at the end of each post when concatenated together. And we won't include them as content in RSS. (Update histories <a href="../../../../xml/iffy/index.html"><em>do</em> get included</a> as additional metadata in RSS. That's built in.) <code>SimpleBlog</code> conveniently distinguishes between <code>Single</code>, <code>Multiple</code>, and <code>Rss</code>; we can just check our presentation and behave appropriately.</p>
   <p>So... We'll</p>
   <ol>
    <li>Steal <a href="https://github.com/swaldman/tech.interfluidity.com/blob/main/untemplate/com/interfluidity/tech/blog/layout-update-history.html.untemplate"><code>layout-update-history.html.untemplate</code></a> from the tech blog, and <a href="https://github.com/swaldman/drafts.interfluidity.com/blob/main/untemplate/com/interfluidity/drafts/mainblog/layout-update-history.html.untemplate">bring it in as a layout of drafts</a>. (I had to import <code>com.interfluidity.drafts.DraftsSite.MainBlog</code>, and modify the link in the note to point to the drafts got repository, rather than the tech rep.)</li>
    <li>Modify <a href="https://github.com/swaldman/drafts.interfluidity.com/blob/main/untemplate/com/interfluidity/drafts/mainblog/layout-entry.html.untemplate"><code>layout-entry.html.untemplate</code></a> in drafts to bring in the new layout of update history. That turns out to be really easy, because we already have logic at the end of our entry layout to restrict addition of previous and next links to single page presentations. So all we have to do is add our update history layout just after the <code>div</code> for those links, but within the conditionally added region. It's literally just 
     <pre><code class="language-plaintext">&lt;( layout_update_history_html( input ) )&gt;
</code></pre>
     <p>inserted just after that <code>div</code>, still within the conditional region.</p></li>
   </ol>
   <h3><a href="#modify-the-main-layout-and-css-so-that-old-revisions-are-visually-distinct-from-and-link-back-to-current-revisions" id="modify-the-main-layout-and-css-so-that-old-revisions-are-visually-distinct-from-and-link-back-to-current-revisions" name="modify-the-main-layout-and-css-so-that-old-revisions-are-visually-distinct-from-and-link-back-to-current-revisions" class="anchorlink"></a>Modify the main layout and CSS so that old revisions are visually distinct from, and link back to, current revisions</h3>
   <p>At the top of the <code>body</code> element of <a href="https://github.com/swaldman/drafts.interfluidity.com/blob/main/untemplate/com/interfluidity/drafts/layout-main.html.untemplate"><code>layout-main.html.untemplate</code></a>, we add an empty <code>div</code> element called <code>top-banner</code>.</p>
   <pre><code class="language-html">  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="top-banner"&gt;&lt;/div&gt;
</code></pre>
   <p>In current revisions, this will remain invisible and empty. But we'll add a bit of javascript to detect if we're in an old revision, and add some HTML with a link back to the current revision. If we are in an old revision, we'll also add a class called <code>old-draft</code> to the body element, so that we can do whatever we feel like in CSS to make the old revision visually distinct.</p>
   <p>We use a javascript regular expression and our current location to decide if we are in an old revision.</p>
   <pre><code class="language-javascript">    &lt;script&gt;
      document.addEventListener("DOMContentLoaded", function() {
          const regex = /(^.*)\-oldcommit\-[0-9A-Fa-f]+\.html/;
          const match = window.location.pathname.match(regex);
          if (match) {
              const b  = document.querySelector("body");
              const tb = document.getElementById("top-banner");
              b.classList.add("old-draft");
              tb.innerHTML = "You are looking at an old, superceded version of this page. For the current version, please &lt;a href=\"" + match[1] + ".html\"&gt;click here&lt;/a&gt;.";
          }
       });
    &lt;/script&gt;
</code></pre>
   <p>We adjust <a href="https://github.com/swaldman/drafts.interfluidity.com/blob/main/static/css/style.css">our main CSS</a> to keep the top-banner <code>div</code> at the top of our document, when it's relevant:</p>
   <pre><code class="language-css">body.old-draft #top-banner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    color: black;
    background-color: yellow;
    text-align: center;
    font-family: 'RobotoCondensed', 'Arial', 'Helvetica', sans-serif;
    font-variation-settings: "wght" 500;
    padding-top: 4px;
    padding-bottom: 4px;
    border-bottom: 2px solid black;
}
</code></pre>
   <p>Also add CSS so that, when viewing old revisions, the documents look, well, old.</p>
   <pre><code class="language-css">body.old-draft {
    padding-top: 1em;
    background-color: #F3F5DA;
    color: #6E7FD9;
    font-family: 'GabrieleD', 'Courier';
}
</code></pre>
   <p>(These choices were inspired by the TT2020 image <a href="https://www.creativebloq.com/typography/free-typewriter-fonts-1131774">here</a>, although ultimately I went for Gabriele, because the TT2020 file sizes were very large.)</p>
   <h3><a href="#add-a-prologue-to-posts-with-revisions-or-that-generate-sprout-rss" id="add-a-prologue-to-posts-with-revisions-or-that-generate-sprout-rss" name="add-a-prologue-to-posts-with-revisions-or-that-generate-sprout-rss" class="anchorlink"></a>Add a prologue to posts with revisions or that generate sprout RSS</h3>
   <p>When a post is a revision or a sprout, we want a prologue that indicated that it is, with links to the prior revision, the update history, and the sprout RSS.</p>
   <p>I'm too lazy to describe what it took to add that in detail, but here's <a href="https://github.com/swaldman/drafts.interfluidity.com/commit/d88d72d099cbe0c542ce2cce039243fb0975e52e">a nice, concise commit</a>. Check out the diff.</p>
   <h3><a href="#miscellaneous-tweaks" id="miscellaneous-tweaks" name="miscellaneous-tweaks" class="anchorlink"></a>Miscellaneous tweaks</h3>
   <p>I don't want to have to import <code>UpdateRecord</code> whenever I want to add update histories to entries, so I added them as an extra import to my <a href="https://github.com/swaldman/untemplate-doc?tab=readme-ov-file#customizers">untemplate customizer</a> in my mill build file, <a href="https://github.com/swaldman/drafts.interfluidity.com/blob/main/build.sc"><code>build.sc</code></a>:</p>
   <pre><code class="language-scala">  override def untemplateSelectCustomizer: untemplate.Customizer.Selector = { key =&gt;
    var out = untemplate.Customizer.empty

    if (key.inferredPackage.indexOf("mainblog")&gt;=0 &amp;&amp; key.inferredFunctionName.startsWith("entry_")) {
      out = out.copy(extraImports=Seq("unstatic.*","com.interfluidity.drafts.DraftsSite.MainBlog","unstatic.ztapir.simple.UpdateRecord"))
    }
</code></pre>
   <p>The "update history note" should be small, so I add to css:</p>
   <pre><code class="language-css">.update-history-note {
    font-size: smaller;
    line-height: 100%;
}
</code></pre>
   <h3><a href="#republish-the-site" id="republish-the-site" name="republish-the-site" class="anchorlink"></a>Republish the site</h3>
   <p>Even though nothing visible should change, let's go ahead and republish the site, so that our javascript and css scaffolding for old-looking updates become available.</p>
   <h3><a href="#test-and-tweak" id="test-and-tweak" name="test-and-tweak" class="anchorlink"></a>Test and tweak</h3>
   <p>Even though I don't have any actual new revisions to create, I added a fake revision history to the most recent post, played around in CSS with the look of the old revision until I liked it, then commented away the fake update history.</p>
  </div>
 </div>
 <div class="entry-footer">
  <div class="post-metainfo">
   <a href="index.html">03:15 AM EDT</a>
  </div>
 </div>
</article>
<div class="after-article">
 <div class="prev-top-next">
  <div class="prev">
   <a href="../green-shoots-of-sprouts/index.html">← Green shoots of sprouts</a>
  </div>
  <div class="top">
   <a href="../../../../index.html">↑↑↑</a>
  </div>
  <div class="next">
  </div>
 </div>
</div><!-- after-article -->
      </div>
      <div id="right-sidebar">
      </div>
    </div>
  </body>
</html>
